<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.5.xsd">


    <changeSet id="#2428_20180105" author="EdwardPLegaspi">
        <addColumn tableName="adm_notif_webhooks">
            <column name="http_protocol" type="varchar(10)" />
        </addColumn>
        <sql>UPDATE ${db.schema.adapted}adm_notif_webhooks SET http_protocol='HTTP'</sql>
        <addNotNullConstraint tableName="adm_notif_webhooks" columnName="http_protocol" columnDataType="varchar(10)" />
    </changeSet>

    <changeSet id="#3170_20180119 Add payment method to invoice" author="EdwardPLegaspi">
        <addColumn tableName="billing_invoice">
            <column name="payment_method_id" type="bigint" />
        </addColumn>
    </changeSet>

    <changeSet id="#2449_20180125" author="EdwardPLegaspi">
        <addColumn tableName="cat_price_plan_matrix">
            <column name="rating_el" type="varchar(2000)" />
        </addColumn>
    </changeSet>


    <changeSet id="#3196_20180131" author="AndriusKarpavicius">
        <modifyDataType tableName="billing_charge_instance" columnName="termination_date" newDataType="datetime" />
        <modifyDataType tableName="billing_charge_instance" columnName="charge_date" newDataType="datetime" />
    </changeSet>
    
    <changeSet id="#3196_20180131-migration" author="AndriusKarpavicius">    
        <sql>update ${db.schema.adapted}billing_recurring_charge_inst set next_charge_date = date(next_charge_date) + cast(subscription_date as time)
        where recurring_chrg_tmpl_id in (select chrgt.id from ${db.schema.adapted}cat_recurring_charge_templ chrgt join ${db.schema.adapted}cat_calendar cal on chrgt.calendar_id = cal.id where cal.cal_type='PERIOD')</sql>
    </changeSet>

    <changeSet id="#2819_20180212" author="AbdelmounaimAkadid">
        <addColumn tableName="crm_seller">
            <column name="email" type="varchar(2000)" />
            <column name="fax" type="varchar(2000)" />
            <column name="mobile" type="varchar(2000)" />
            <column name="phone" type="varchar(2000)" />
        </addColumn>
    </changeSet>

    <changeSet id="#2792_20170919" author="AndriusKarpavicius">
        <sql>update ${db.schema.adapted}cat_usage_charge_template set filter_expression=null where filter_expression=''</sql>
        <sql>update ${db.schema.adapted}cat_usage_charge_template set filter_param_1=null where filter_param_1=''</sql>
        <sql>update ${db.schema.adapted}cat_usage_charge_template set filter_param_2=null where filter_param_2=''</sql>
        <sql>update ${db.schema.adapted}cat_usage_charge_template set filter_param_3=null where filter_param_3=''</sql>
        <sql>update ${db.schema.adapted}cat_usage_charge_template set filter_param_4=null where filter_param_4=''</sql>

        <sql>update ${db.schema.adapted}cat_triggered_edr set condition_el=null where condition_el=''</sql>
        <sql>update ${db.schema.adapted}cat_triggered_edr set param_1_el=null where param_1_el=''</sql>
        <sql>update ${db.schema.adapted}cat_triggered_edr set param_2_el=null where param_2_el=''</sql>
        <sql>update ${db.schema.adapted}cat_triggered_edr set param_3_el=null where param_3_el=''</sql>
        <sql>update ${db.schema.adapted}cat_triggered_edr set param_4_el=null where param_4_el=''</sql>
        <sql>update ${db.schema.adapted}cat_triggered_edr set quantity_el=null where quantity_el=''</sql>
        <sql>update ${db.schema.adapted}cat_triggered_edr set subscription_el=null where subscription_el=''</sql>
    </changeSet>


    <changeSet id="#2792_20180110" author="AndriusKarpavicius">
        <sql>update ${db.schema.adapted}cat_price_plan_matrix set criteria_1=null where criteria_1=''</sql>
        <sql>update ${db.schema.adapted}cat_price_plan_matrix set criteria_2=null where criteria_2=''</sql>
        <sql>update ${db.schema.adapted}cat_price_plan_matrix set criteria_3=null where criteria_3=''</sql>
        <sql>update ${db.schema.adapted}cat_price_plan_matrix set criteria_el=null where criteria_el=''</sql>
        <sql>update ${db.schema.adapted}cat_price_plan_matrix set amount_without_tax_el=null where amount_without_tax_el=''</sql>
        <sql>update ${db.schema.adapted}cat_price_plan_matrix set amount_with_tax_el=null where amount_with_tax_el=''</sql>

        <sql>CREATE INDEX cat_price_plan_event_c_index ON ${db.schema.adapted}cat_price_plan_matrix(event_code)</sql>
        <sql>CREATE INDEX medina_access_user_id_index ON ${db.schema.adapted}medina_access(acces_user_id)</sql>
    </changeSet>

    <changeSet id="#2792_20180119" author="AndriusKarpavicius">
        <sql>CREATE INDEX bc_instance_sub_id ON ${db.schema.adapted}billing_charge_instance(subscription_id)</sql>
        <sql>CREATE INDEX counter_period_ci_id ON ${db.schema.adapted}billing_counter_period(counter_instance_id)</sql>
        <addColumn tableName="billing_usage_charge_inst">
            <column defaultValueNumeric="1" name="priority" type="int4" />
        </addColumn>
    </changeSet>

    <changeSet id="#2792_20180119_migration_P" author="AndriusKarpavicius" dbms="postgresql">
        <sql>update ${db.schema.adapted}billing_usage_charge_inst set priority = cat_usage_charge_template.priority from ${db.schema.adapted}billing_charge_instance, ${db.schema.adapted}cat_usage_charge_template where
            billing_charge_instance.id=billing_usage_charge_inst.id and
            billing_charge_instance.charge_template_id=cat_usage_charge_template.id
        </sql>
    </changeSet>

    <changeSet id="#2792_20180119_migration_M" author="AndriusKarpavicius" dbms="mysql">
        <sql>update ${db.schema.adapted}billing_usage_charge_inst join ${db.schema.adapted}billing_charge_instance on billing_charge_instance.id=billing_usage_charge_inst.id join ${db.schema.adapted}cat_usage_charge_template on
            billing_charge_instance.charge_template_id=cat_usage_charge_template.id set billing_usage_charge_inst.priority = cat_usage_charge_template.priority
        </sql>
    </changeSet>
    
    <changeSet author="EdwardPLegaspi" id="#2370_20180306 - customer categories">
        <createTable tableName="cat_product_offer_customer_category">
            <column name="product_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="customer_category_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="indx" type="int4">
                <constraints nullable="false" />
            </column>
        </createTable>
        <addPrimaryKey columnNames="product_id, customer_category_id" constraintName="cat_product_offer_customer_category_pkey" tableName="cat_product_offer_customer_category" />
    </changeSet>

    <changeSet id="#3190_26012018_2" author="anasseh" dbms="mysql">
        <createTable tableName="ar_payment_history_seq">
            <column name="next_val" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="payment_history_seq_pk" />
            </column>
        </createTable>
        <sql>insert into ${db.schema.adapted}ar_payment_history_seq values(1)</sql>
    </changeSet>

    <changeSet author="anasseh" id="#3190_26012018">
        <createSequence sequenceName="ar_payment_history_seq" />
        <createTable tableName="ar_payment_history">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="ar_payment_history_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="disabled" type="${type.boolean}" defaultValueNumeric="0">
                <constraints nullable="false" />
            </column>
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="customer_account_code" type="varchar(255)">
                <constraints nullable="false" />
            </column>
            <column name="customer_account_name" type="varchar(255)" />
            <column name="seller_code" type="varchar(255)" />

            <column name="operation_date" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="last_update_date" type="datetime" />
            <column name="amount_cts" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="sync_status" type="varchar(50)">
                <constraints nullable="false" />
            </column>
            <column name="async_status" type="varchar(50)" />
            <column name="status" type="varchar(50)" />
            <column name="external_payment_id" type="varchar(255)" />
            <column name="error_code" type="varchar(255)" />
            <column name="error_message" type="varchar(2000)" />
            <column name="error_type" type="varchar(50)" />
            <column name="operation_category" type="varchar(50)">
                <constraints nullable="false" />
            </column>
            <column name="payment_gateway_code" type="varchar(255)" />
            <column name="payment_method_type" type="varchar(50)" />
            <column name="payment_method_name" type="varchar(50)" />
            <column name="payment_id" type="bigint" />
            <column name="refund_id" type="bigint" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
        </createTable>

        <addForeignKeyConstraint baseColumnNames="payment_id" baseTableName="ar_payment_history" constraintName="fk_payhisto_ao_pay" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="ar_account_operation" />

        <addForeignKeyConstraint baseColumnNames="refund_id" baseTableName="ar_payment_history" constraintName="fk_payhisto_ao_refund" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="ar_account_operation" />
    </changeSet>

    <changeSet author="anasseh" id="#3136_07022018">
        <sql>update ${db.schema.adapted}meveo_job_instance set cf_values = replace (cf_values, 'PaymentCardJob_','PaymentJob_'), job_template = replace(job_template,'PaymentCardJob','PaymentJob') </sql>
        <sql>update ${db.schema.adapted}crm_custom_field_tmpl set code = replace (code, 'PaymentCardJob_','PaymentJob_'), applies_to = replace (applies_to, 'JOB_PaymentCardJob','JOB_PaymentJob') </sql>
    </changeSet>

    <changeSet author="anasseh" id="#2830_15022018">
        <!-- account_entity -->
        <addColumn tableName="account_entity">
            <column name="address_country_id" type="bigint" />
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="address_country_id" baseTableName="account_entity" constraintName="fk_country_id_account" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_country" />
        <sql>update ${db.schema.adapted}account_entity ae set address_country_id = (select ac.id from ${db.schema.adapted}adm_country ac where upper(ac.description) like '%'|| upper(ae.address_country) ||'%' or
            upper(ac.description_i18n )like '%'|| upper(ae.address_country) ||'%' limit 1) </sql>
        <dropColumn tableName="account_entity" columnName="address_country" />

        <!-- com_sender_config -->
        <addColumn tableName="com_sender_config">
            <column name="address_country_id" type="bigint" />
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="address_country_id" baseTableName="com_sender_config" constraintName="fk_country_id_sender" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_country" />
        <sql>update ${db.schema.adapted}com_sender_config ae set address_country_id = (select ac.id from ${db.schema.adapted}adm_country ac where upper(ac.description) like '%'|| upper(ae.address_country) ||'%' or
            upper(ac.description_i18n )like '%'|| upper(ae.address_country) ||'%' limit 1) </sql>
        <dropColumn tableName="com_sender_config" columnName="address_country" />

        <!-- crm_provider_contact -->
        <addColumn tableName="crm_provider_contact">
            <column name="address_country_id" type="bigint" />
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="address_country_id" baseTableName="crm_provider_contact" constraintName="fk_country_id_prov_contact" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_country" />
        <sql>update ${db.schema.adapted}crm_provider_contact ae set address_country_id = (select ac.id from ${db.schema.adapted}adm_country ac where upper(ac.description) like '%'|| upper(ae.address_country) ||'%' or
            upper(ac.description_i18n )like '%'|| upper(ae.address_country) ||'%' limit 1) </sql>
        <dropColumn tableName="crm_provider_contact" columnName="address_country" />

        <!-- crm_provider -->
        <addColumn tableName="crm_provider">
            <column name="address_country_id" type="bigint" />
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="address_country_id" baseTableName="crm_provider" constraintName="fk_country_id_prov" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_country" />
        <sql>update ${db.schema.adapted}crm_provider ae set address_country_id = (select ac.id from ${db.schema.adapted}adm_country ac where upper(ac.description) like '%'|| upper(ae.address_country) ||'%' or upper(ac.description_i18n
            )like '%'|| upper(ae.address_country) ||'%' limit 1) </sql>
        <dropColumn tableName="crm_provider" columnName="address_country" />

        <!-- crm_seller -->
        <addColumn tableName="crm_seller">
            <column name="address_country_id" type="bigint" />
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="address_country_id" baseTableName="crm_seller" constraintName="fk_country_id_seller" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_country" />
        <sql>update ${db.schema.adapted}crm_seller ae set address_country_id = (select ac.id from ${db.schema.adapted}adm_country ac where upper(ac.description) like '%'|| upper(ae.address_country) ||'%' or upper(ac.description_i18n
            )like '%'|| upper(ae.address_country) ||'%' limit 1) </sql>
        <dropColumn tableName="crm_seller" columnName="address_country" />

        <!-- ord_order_item -->
        <addColumn tableName="ord_order_item">
            <column name="address_country_id" type="bigint" />
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="address_country_id" baseTableName="ord_order_item" constraintName="fk_country_id_order" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_country" />
        <sql>update ${db.schema.adapted}ord_order_item ae set address_country_id = (select ac.id from ${db.schema.adapted}adm_country ac where upper(ac.description) like '%'|| upper(ae.address_country) ||'%' or
            upper(ac.description_i18n )like '%'|| upper(ae.address_country) ||'%' limit 1) </sql>
        <dropColumn tableName="ord_order_item" columnName="address_country" />
    </changeSet>

    <changeSet id="#2875_20171201" author="anasseh">
        <addColumn tableName="ar_payment_gateway">
            <column name="country_id" type="bigint" />
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="country_id" baseTableName="ar_payment_gateway" constraintName="fk_paygw_country" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_country" />

        <addColumn tableName="ar_payment_gateway">
            <column name="nb_tries" type="int" />
            <column name="replay_cause" type="varchar(100)" />
            <column name="errors_to_replay" type="varchar(400)" />
        </addColumn>
    </changeSet>

    <changeSet id="#2875_20171201-M" author="anasseh" dbms="mysql">
        <dropForeignKeyConstraint baseTableName="ar_payment_gateway" constraintName="fk_paygw_trad_country"/>
        <dropIndex tableName="ar_payment_gateway" indexName="fk_paygw_trad_country"/>
    </changeSet>

    <changeSet id="#2875_20171201-End" author="anasseh">
        <dropColumn tableName="ar_payment_gateway" columnName="trading_country_id" />
    </changeSet>
    
    <changeSet id="#2870_20180129" author="EdwardLegaspi">
        <createTable tableName="dwh_report_extract">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="dwh_report_extract_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="disabled" type="${type.boolean}" defaultValueNumeric="0">
                <constraints nullable="false" />
            </column>
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="code" type="varchar(255)">
                <constraints nullable="false" />
            </column>
            <column name="description" type="varchar(255)" />
            <column name="category" type="varchar(50)" />
            <column name="script_type" type="varchar(10)">
            	<constraints nullable="false"/>
           	</column>
            <column name="filename_format" type="varchar(100)">
            	<constraints nullable="false"/>
            </column>
            <column name="sql_query" type="varchar(2000)" />
            <column name="script_instance_id" type="bigint" />
		</createTable>
		
		<addForeignKeyConstraint baseColumnNames="script_instance_id" baseTableName="dwh_report_extract" constraintName="fk_report_extract_script_instance" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="meveo_script_instance" />
		<createSequence sequenceName="dwh_report_extract_seq" />
		
		<createTable tableName="dwh_report_extract_params">
            <column name="reportextract_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="params" type="varchar(255)" />
            <column name="params_key" type="varchar(255)">
                <constraints nullable="false" />
            </column>
        </createTable>
        <addPrimaryKey columnNames="reportextract_id, params_key" constraintName="pk_report_extract_params" tableName="dwh_report_extract_params" />
    </changeSet>
    
     <changeSet id="#2870_20180129 Mysql" author="EdwardLegaspi" dbms="mysql">
        <createTable tableName="dwh_report_extract_seq">
            <column name="next_val" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="dwh_report_extract_seq_pk" />
            </column>
        </createTable>
        <sql>insert into ${db.schema.adapted}dwh_report_extract_seq values(1)</sql>
     </changeSet>
     
     <changeSet id="#3234_13032018_1 - Homogenization of Account Operation types" author="anansseh" dbms="mysql">
	    <sql>insert into ${db.schema.adapted}ar_occ_template (version,disabled,created,account_code,account_code_client_side,code, description,occ_category,creator) values (0,0,CURRENT_TIMESTAMP(),'411000000','445510000','TAX_VAT_00','Tax - VAT','DEBIT','opencell.admin')</sql>
		<sql>insert into ${db.schema.adapted}ar_occ_template (version,disabled,created,account_code,account_code_client_side,code, description,occ_category,creator) values (0,0,CURRENT_TIMESTAMP(),'411000000','445510000','TAX_VAT_05','Tax - VAT','DEBIT','opencell.admin')</sql>
		<sql>insert into ${db.schema.adapted}ar_occ_template (version,disabled,created,account_code,account_code_client_side,code, description,occ_category,creator) values (0,0,CURRENT_TIMESTAMP(),'411000000','445510000','TAX_VAT_20','Tax - VAT','DEBIT','opencell.admin')</sql>
		<sql>insert into ${db.schema.adapted}ar_occ_template (version,disabled,created,account_code,account_code_client_side,code, description,occ_category,creator) values (0,0,CURRENT_TIMESTAMP(),'411000000','445510000','TAX_VAT_10','Tax - VAT','DEBIT','opencell.admin')</sql>
		<sql>insert into ${db.schema.adapted}ar_occ_template (version,disabled,created,account_code,account_code_client_side,code, description,occ_category,creator) values (0,0,CURRENT_TIMESTAMP(),'512010000','411000000','REJ_CRD','Rejected payment - card','DEBIT','opencell.admin')</sql>
		<sql>insert into ${db.schema.adapted}ar_occ_template (version,disabled,created,account_code,account_code_client_side,code, description,occ_category,creator) values (0,0,CURRENT_TIMESTAMP(),'512010000','411000000','REJ_RCR','Rejected refund - card','CREDIT','opencell.admin')</sql>
		<sql>insert into ${db.schema.adapted}ar_occ_template (version,disabled,created,account_code,account_code_client_side,code, description,occ_category,creator) values (0,0,CURRENT_TIMESTAMP(),'512010000','411000000','REJ_RDD','Rejected refund - direct debit','CREDIT','opencell.admin')</sql>
		<sql>insert into ${db.schema.adapted}ar_occ_template (version,disabled,created,account_code,account_code_client_side,code, description,occ_category,creator) values (0,0,CURRENT_TIMESTAMP(),'411000000','709000000','INV_REB','Invoice - rebate sub-item','CREDIT','opencell.admin')</sql>
		<sql>insert into ${db.schema.adapted}ar_occ_template (version,disabled,created,account_code,account_code_client_side,code, description,occ_category,creator) values (0,0,CURRENT_TIMESTAMP(),'411000000','709000000','INV_DIS','Invoice - discount sub-item','CREDIT','opencell.admin')</sql>
		<sql>insert into ${db.schema.adapted}ar_occ_template (version,disabled,created,account_code,account_code_client_side,code, description,occ_category,creator) values (0,0,CURRENT_TIMESTAMP(),'411000000','701000000','INV_CRN','Invoice - credit note sub-item','CREDIT','opencell.admin')</sql>
		<sql>insert into ${db.schema.adapted}ar_occ_template (version,disabled,created,account_code,account_code_client_side,code, description,occ_category,creator) values (0,0,CURRENT_TIMESTAMP(),'512010000','411000000','REF_TIP','Refund - TIP','DEBIT','opencell.admin')</sql>		
    </changeSet>
     
    <changeSet id="#3234_13032018_2 - Homogenization of Account Operation types" author="anansseh" dbms="postgresql">
	    <sql>insert into ${db.schema.adapted}ar_occ_template (id,version,disabled,created,account_code,account_code_client_side,code, description,occ_category,creator) values (nextval('${db.schema.adapted}ar_occ_template_seq'),0,0,current_timestamp,'411000000','445510000','TAX_VAT_00','Tax - VAT','DEBIT','opencell.admin')</sql>
		<sql>insert into ${db.schema.adapted}ar_occ_template (id,version,disabled,created,account_code,account_code_client_side,code, description,occ_category,creator) values (nextval('${db.schema.adapted}ar_occ_template_seq'),0,0,current_timestamp,'411000000','445510000','TAX_VAT_05','Tax - VAT','DEBIT','opencell.admin')</sql>
		<sql>insert into ${db.schema.adapted}ar_occ_template (id,version,disabled,created,account_code,account_code_client_side,code, description,occ_category,creator) values (nextval('${db.schema.adapted}ar_occ_template_seq'),0,0,current_timestamp,'411000000','445510000','TAX_VAT_20','Tax - VAT','DEBIT','opencell.admin')</sql>
		<sql>insert into ${db.schema.adapted}ar_occ_template (id,version,disabled,created,account_code,account_code_client_side,code, description,occ_category,creator) values (nextval('${db.schema.adapted}ar_occ_template_seq'),0,0,current_timestamp,'411000000','445510000','TAX_VAT_10','Tax - VAT','DEBIT','opencell.admin')</sql>
		<sql>insert into ${db.schema.adapted}ar_occ_template (id,version,disabled,created,account_code,account_code_client_side,code, description,occ_category,creator) values (nextval('${db.schema.adapted}ar_occ_template_seq'),0,0,current_timestamp,'512010000','411000000','REJ_CRD','Rejected payment - card','DEBIT','opencell.admin')</sql>
		<sql>insert into ${db.schema.adapted}ar_occ_template (id,version,disabled,created,account_code,account_code_client_side,code, description,occ_category,creator) values (nextval('${db.schema.adapted}ar_occ_template_seq'),0,0,current_timestamp,'512010000','411000000','REJ_RCR','Rejected refund - card','CREDIT','opencell.admin')</sql>
		<sql>insert into ${db.schema.adapted}ar_occ_template (id,version,disabled,created,account_code,account_code_client_side,code, description,occ_category,creator) values (nextval('${db.schema.adapted}ar_occ_template_seq'),0,0,current_timestamp,'512010000','411000000','REJ_RDD','Rejected refund - direct debit','CREDIT','opencell.admin')</sql>
		<sql>insert into ${db.schema.adapted}ar_occ_template (id,version,disabled,created,account_code,account_code_client_side,code, description,occ_category,creator) values (nextval('${db.schema.adapted}ar_occ_template_seq'),0,0,current_timestamp,'411000000','709000000','INV_REB','Invoice - rebate sub-item','CREDIT','opencell.admin')</sql>
		<sql>insert into ${db.schema.adapted}ar_occ_template (id,version,disabled,created,account_code,account_code_client_side,code, description,occ_category,creator) values (nextval('${db.schema.adapted}ar_occ_template_seq'),0,0,current_timestamp,'411000000','709000000','INV_DIS','Invoice - discount sub-item','CREDIT','opencell.admin')</sql>
		<sql>insert into ${db.schema.adapted}ar_occ_template (id,version,disabled,created,account_code,account_code_client_side,code, description,occ_category,creator) values (nextval('${db.schema.adapted}ar_occ_template_seq'),0,0,current_timestamp,'411000000','701000000','INV_CRN','Invoice - credit note sub-item','CREDIT','opencell.admin')</sql>
		<sql>insert into ${db.schema.adapted}ar_occ_template (id,version,disabled,created,account_code,account_code_client_side,code, description,occ_category,creator) values (nextval('${db.schema.adapted}ar_occ_template_seq'),0,0,current_timestamp,'512010000','411000000','REF_TIP','Refund - TIP','DEBIT','opencell.admin')</sql>		
    </changeSet>
    <changeSet id="#3234_13032018_3 - Homogenization of Account Operation types" author="anansseh">
        <sql>update ${db.schema.adapted}ar_occ_template set code='INV_STD', description='Standard invoice sub-item', account_code='411000000', account_code_client_side='445510000' , creator = 'opencell.admin' where code ='FA_FACT'</sql>
		<sql>delete from ${db.schema.adapted}ar_occ_template where code ='OD_PREL'</sql>
		<sql>update ${db.schema.adapted}ar_occ_template set code='INV_FEE', description='Fee - late payment', account_code='411000000', account_code_client_side='763100000' , creator = 'opencell.admin' where code ='OD_PIMP'</sql>
		<sql>update ${db.schema.adapted}ar_occ_template set code='PAY_TIP', description='Payment - TIP', account_code='512010000', account_code_client_side='411000000', creator = 'opencell.admin' where code ='RG_TIP'</sql>
		<sql>update ${db.schema.adapted}ar_occ_template set code='PAY_CHK', description='Payment - check', account_code='512010000', account_code_client_side='411000000', creator = 'opencell.admin' where code ='RG_CHQ'</sql>
		<sql>update ${db.schema.adapted}ar_occ_template set code='PAY_DDT', description='Payment - direct debit', account_code='512010000', account_code_client_side='411000000', creator = 'opencell.admin' where code ='RG_PLVT'</sql>
		<sql>update ${db.schema.adapted}ar_occ_template set code='PAY_CRD', description='Payment - card', account_code='512010000', account_code_client_side='411000000', creator = 'opencell.admin' where code ='RG_CARD'</sql>
		<sql>update ${db.schema.adapted}ar_occ_template set code='PAY_DEP', description='Other - deposit', account_code='512010000', account_code_client_side='419110000', creator = 'opencell.admin' where code ='OD_ACPT'</sql>
		<sql>update ${db.schema.adapted}ar_occ_template set code='PAY_NID', description='Other - unidentified payment', account_code='512010000', account_code_client_side='419120000', creator = 'opencell.admin' where code ='RG_CHQNI'</sql>
		<sql>update ${db.schema.adapted}ar_occ_template set code='PAY_REC', description='Other - unidentified payment', account_code='512010000', account_code_client_side='419120000', creator = 'opencell.admin' where code ='RG_VIRTNI'</sql>
		<sql>update ${db.schema.adapted}ar_occ_template set code='REF_CHK', description='Refund - check', account_code='512010000', account_code_client_side='411000000', creator = 'opencell.admin' where code ='RB_CHQ'</sql>
		<sql>update ${db.schema.adapted}ar_occ_template set code='REF_DDT', description='Refund - direct debit', account_code='512010000', account_code_client_side='411000000', creator = 'opencell.admin' where code ='RB_PLVT'</sql>
		<sql>update ${db.schema.adapted}ar_occ_template set code='REF_CRD', description='Refund - card', account_code='512010000', account_code_client_side='411000000', creator = 'opencell.admin' where code ='RF_CARD'</sql>
		<sql>update ${db.schema.adapted}ar_occ_template set code='REJ_CHK', description='Rejected payment - check', account_code='512010000', account_code_client_side='411000000', creator = 'opencell.admin' where code ='IP_CHQ'</sql>
		<sql>update ${db.schema.adapted}ar_occ_template set code='REJ_DDT', description='Rejected payment - direct debit', account_code='512010000', account_code_client_side='411000000', creator = 'opencell.admin' where code ='IP_PLVT'</sql>
		<sql>update ${db.schema.adapted}ar_occ_template set code='REJ_TIP', description='Rejected payment - TIP', account_code='512010000', account_code_client_side='411000000', creator = 'opencell.admin' where code ='IP_TIP'</sql>
		<sql>update ${db.schema.adapted}ar_occ_template set code='RND_EXP', description='Expense - payment rounding', account_code='658100000', account_code_client_side='411000000' , occ_category='DEBIT', creator = 'opencell.admin' where code ='OD_PERT'</sql>
		<sql>update ${db.schema.adapted}ar_occ_template set code='RND_INC', description='Income - payment rounding', account_code='758100000', account_code_client_side='411000000' , occ_category='CREDIT' , creator = 'opencell.admin' where code ='OD_PROF'</sql>
		<sql>update ${db.schema.adapted}ar_occ_template set code='EXP_WRT', description='Expense - bad debt write-off', account_code='654100000', account_code_client_side='411000000' , occ_category='DEBIT', creator = 'opencell.admin' where code ='OD_PERT'</sql>
		<sql>update ${db.schema.adapted}billing_invoice_type set occ_templ_negative_id = (select id from ${db.schema.adapted}ar_occ_template where code = 'INV_CRN') where code = 'COM'</sql>
		<sql>update ${db.schema.adapted}billing_invoice_type set occ_template_id = (select id from ${db.schema.adapted}ar_occ_template where code = 'INV_CRN') where code = 'ADJ'</sql>
		<sql>delete from ${db.schema.adapted}ar_occ_template where code ='FA_ADJ'</sql>
		<sql>delete from ${db.schema.adapted}ar_occ_template where code ='FA_N_FACT'</sql>
		<sql>delete from ${db.schema.adapted}ar_occ_template where code ='OD_NI_CL'</sql>
		<sql>delete from ${db.schema.adapted}ar_occ_template where code ='OD_ODC'</sql>
		<sql>delete from ${db.schema.adapted}ar_occ_template where code ='OD_ODD'</sql>
		<sql>delete from ${db.schema.adapted}ar_occ_template where code ='OD_CC_CL'</sql>
		<sql>delete from ${db.schema.adapted}ar_occ_template where code ='OD_CL_NI'</sql>
		<sql>delete from ${db.schema.adapted}ar_occ_template where code ='RG_VIRT'</sql>
		<sql>delete from ${db.schema.adapted}ar_occ_template where code ='TRANS_CRED'</sql>
		<sql>delete from ${db.schema.adapted}ar_occ_template where code ='TRANS_DEB'</sql>
		<sql>delete from ${db.schema.adapted}ar_occ_template where code ='OD_EXC'</sql>
		<sql>delete from ${db.schema.adapted}ar_occ_template where code ='OD_IRRE'</sql>
		<sql>delete from ${db.schema.adapted}ar_occ_template where code ='OD_CL_CC'</sql>				
    </changeSet>

    <changeSet id="#1705_20180219" author="EdwardPLegaspi">
    	<createTable tableName="billing_accounting_code">
	    	<column name="id" type="bigint" autoIncrement="${id.auto}">
	            <constraints nullable="false" primaryKey="true" primaryKeyName="billing_accounting_code_pkey" />
	        </column>
	        <column name="version" type="int4" />
	        <column name="disabled" type="${type.boolean}" defaultValueNumeric="0">
	            <constraints nullable="false" />
	        </column>
	        <column name="created" type="datetime">
	            <constraints nullable="false" />
	        </column>
	        <column name="updated" type="datetime" />
	        <column name="code" type="varchar(255)">
	            <constraints nullable="false" />
	        </column>
	        <column name="description" type="varchar(255)" />
	        <column name="creator" type="varchar(100)" />
	        <column name="updater" type="varchar(100)" />
	        <column name="parent_accounting_code_id" type="bigint" />
			<column name="chart_of_account_type" type="varchar(25)" />
			<column name="reporting_account" type="varchar(50)" />        
	        <column name="chart_of_account_view_type" type="varchar(25)" />
	        <column name="notes" type="varchar(2000)" />
	        <column name="migrated" type="${type.boolean}" defaultValueNumeric="0">
                <constraints nullable="false" />
            </column>
		</createTable>
        
        <createSequence sequenceName="billing_accounting_code_seq" />
        <addUniqueConstraint columnNames="code" constraintName="uk_billing_accounting_code" deferrable="false" disabled="false" initiallyDeferred="false" tableName="billing_accounting_code" />
        <addForeignKeyConstraint baseColumnNames="parent_accounting_code_id" baseTableName="billing_accounting_code" constraintName="fk_billing_accounting_code_parent" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_accounting_code" />
            
        <addColumn tableName="billing_invoice_sub_cat">
        	<column name="accounting_code_id" type="bigint"></column>
        </addColumn>
        <addColumn tableName="billing_tax">
        	<column name="accounting_code_id" type="bigint"></column>
        </addColumn>
        <addColumn tableName="billing_invoice_agregate">
        	<column name="accounting_code_id" type="bigint"></column>
        </addColumn>
        <addColumn tableName="dwh_account_operation">
        	<column name="accounting_code_id" type="bigint"></column>
        </addColumn>
        <addColumn tableName="dwh_journal_entries">
        	<column name="accounting_code_id" type="bigint"></column>
        </addColumn>
        <addColumn tableName="ar_occ_template">
        	<column name="accounting_code_id" type="bigint"></column>
        </addColumn>
        <addColumn tableName="ar_account_operation">
        	<column name="accounting_code_id" type="bigint"></column>
        </addColumn>
        
        <addForeignKeyConstraint constraintName="fk_billing_invoice_sub_cat_accounting_code" referencedTableName="billing_accounting_code" baseColumnNames="accounting_code_id" baseTableName="billing_invoice_sub_cat" referencedColumnNames="id"/>
        <addForeignKeyConstraint constraintName="fk_billing_tax_accounting_code" referencedTableName="billing_accounting_code" baseColumnNames="accounting_code_id" baseTableName="billing_tax" referencedColumnNames="id"/>
        <addForeignKeyConstraint constraintName="fk_billing_invoice_aggregate_accounting_code" referencedTableName="billing_accounting_code" referencedColumnNames="id" baseTableName="billing_invoice_agregate" baseColumnNames="accounting_code_id" />
        <addForeignKeyConstraint constraintName="fk_dwh_account_operation_accounting_code" referencedTableName="billing_accounting_code" referencedColumnNames="id" baseTableName="dwh_account_operation" baseColumnNames="accounting_code_id" />
        <addForeignKeyConstraint constraintName="fk_dwh_journal_entries_accounting_code" referencedTableName="billing_accounting_code" referencedColumnNames="id" baseTableName="dwh_journal_entries" baseColumnNames="accounting_code_id" />
        <addForeignKeyConstraint constraintName="fk_ar_occ_template_accounting_code" referencedTableName="billing_accounting_code" referencedColumnNames="id" baseTableName="ar_occ_template" baseColumnNames="accounting_code_id" />
        <addForeignKeyConstraint constraintName="fk_ar_account_operation_accounting_code" referencedTableName="billing_accounting_code" referencedColumnNames="id" baseTableName="ar_account_operation" baseColumnNames="accounting_code_id" />
    </changeSet>
    
    <changeSet id="#1705_20180219 Mysql" author="EdwardPLegaspi" dbms="mysql">
        <createTable tableName="billing_accounting_code_seq">
            <column name="next_val" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="billing_accounting_code_seq_pk" />
            </column>
        </createTable>
        <sql>insert into ${db.schema.adapted}billing_accounting_code_seq values(1)</sql>
    </changeSet>
    
    <changeSet id="#1705_20180220-migration" author="EdwardPLegaspi" dbms="postgresql">
    	<sql>
			<![CDATA[
			insert into ${db.schema.adapted}billing_accounting_code (code, id, version, disabled, created, creator, chart_of_account_type, chart_of_account_view_type)
				select a.accounting_code, nextval('${db.schema.adapted}billing_accounting_code_seq'), 0, 0, now(), null, 'ASSETS', 'REGULAR' 
			    from 
			        (select distinct accounting_code from ${db.schema.adapted}billing_invoice_sub_cat where accounting_code is not null and accounting_code<>'' 
					and not exists(select * from ${db.schema.adapted}billing_accounting_code where code=accounting_code)) a;
			]]>
		</sql>
		<sql>
			<![CDATA[
			update ${db.schema.adapted}billing_invoice_sub_cat set accounting_code_id=(select id from ${db.schema.adapted}billing_accounting_code where code=accounting_code);
			]]>
		</sql>
		<sql>
			<![CDATA[
			insert into ${db.schema.adapted}billing_accounting_code (code, id, version, disabled, created, creator, chart_of_account_type, chart_of_account_view_type)
				select a.accounting_code, nextval('${db.schema.adapted}billing_accounting_code_seq'), 0, 0, now(), null, 'ASSETS', 'REGULAR' 
			    from 
			        (select distinct accounting_code from ${db.schema.adapted}billing_tax where accounting_code is not null and accounting_code<>'' 
					and not exists(select * from ${db.schema.adapted}billing_accounting_code where code=accounting_code)) a;
			]]>
		</sql>
		<sql>
			<![CDATA[update ${db.schema.adapted}billing_tax set accounting_code_id=(select id from ${db.schema.adapted}billing_accounting_code where code=accounting_code);]]>
		</sql>
		<sql>
			<![CDATA[
			insert into ${db.schema.adapted}billing_accounting_code (code, id, version, disabled, created, creator, chart_of_account_type, chart_of_account_view_type)
				select a.account_code, nextval('${db.schema.adapted}billing_accounting_code_seq'), 0, 0, now(), null, 'ASSETS', 'REGULAR' 
			    from 
			        (select distinct account_code from ${db.schema.adapted}ar_occ_template where account_code is not null and account_code<>'' 
					and not exists(select * from ${db.schema.adapted}billing_accounting_code where code=account_code)) a;
			]]>
		</sql>
		<sql>
			<![CDATA[update ${db.schema.adapted}ar_occ_template set accounting_code_id=(select id from ${db.schema.adapted}billing_accounting_code where code=account_code);]]>
		</sql>
		<sql>
			<![CDATA[update ${db.schema.adapted}billing_invoice_agregate set accounting_code_id=(select id from ${db.schema.adapted}billing_accounting_code where code=accounting_code);]]>
		</sql>
		<sql>
			<![CDATA[update ${db.schema.adapted}dwh_account_operation set accounting_code_id=(select id from ${db.schema.adapted}billing_accounting_code where code=accounting_code);]]>
		</sql>
		<sql>
			<![CDATA[update ${db.schema.adapted}dwh_journal_entries set accounting_code_id=(select id from ${db.schema.adapted}billing_accounting_code where code=accounting_code);]]>
		</sql>
		<sql>
			<![CDATA[update ${db.schema.adapted}ar_account_operation set accounting_code_id=(select id from ${db.schema.adapted}billing_accounting_code where code=account_code);]]>
		</sql>
		
		<sql>
			<![CDATA[update ${db.schema.adapted}billing_accounting_code set migrated=1;]]>
		</sql>
	</changeSet>

    <changeSet id="#1705_20180220-migration-M" author="EdwardPLegaspi" dbms="mysql">
        <sql>
			<![CDATA[
			insert into ${db.schema.adapted}billing_accounting_code (code, id, version, disabled, created, creator, chart_of_account_type, chart_of_account_view_type)
				select a.accounting_code, null, 0, 0, now(), null, 'ASSETS', 'REGULAR' 
			    from 
			        (select distinct accounting_code from ${db.schema.adapted}billing_invoice_sub_cat where accounting_code is not null and accounting_code<>'' 
					and not exists(select * from ${db.schema.adapted}billing_accounting_code where code=accounting_code)) a;
			]]>
		</sql>
		<sql>
			<![CDATA[
			update ${db.schema.adapted}billing_invoice_sub_cat set accounting_code_id=(select id from ${db.schema.adapted}billing_accounting_code where code=accounting_code);
			]]>
		</sql>
		<sql>
			<![CDATA[
			insert into ${db.schema.adapted}billing_accounting_code (code, id, version, disabled, created, creator, chart_of_account_type, chart_of_account_view_type)
				select a.accounting_code, null, 0, 0, now(), null, 'ASSETS', 'REGULAR' 
			    from 
			        (select distinct accounting_code from ${db.schema.adapted}billing_tax where accounting_code is not null and accounting_code<>'' 
					and not exists(select * from ${db.schema.adapted}billing_accounting_code where code=accounting_code)) a;
			]]>
		</sql>
		<sql>
			<![CDATA[update ${db.schema.adapted}billing_tax set accounting_code_id=(select id from ${db.schema.adapted}billing_accounting_code where code=accounting_code);]]>
		</sql>
		<sql>
			<![CDATA[
			insert into ${db.schema.adapted}billing_accounting_code (code, id, version, disabled, created, creator, chart_of_account_type, chart_of_account_view_type)
				select a.account_code, null, 0, 0, now(), null, 'ASSETS', 'REGULAR' 
			    from 
			        (select distinct account_code from ${db.schema.adapted}ar_occ_template where account_code is not null and account_code<>'' 
					and not exists(select * from ${db.schema.adapted}billing_accounting_code where code=account_code)) a;
			]]>
		</sql>
		<sql>
			<![CDATA[update ${db.schema.adapted}ar_occ_template set accounting_code_id=(select id from ${db.schema.adapted}billing_accounting_code where code=account_code);]]>
		</sql>
		<sql>
			<![CDATA[update ${db.schema.adapted}billing_invoice_agregate set accounting_code_id=(select id from ${db.schema.adapted}billing_accounting_code where code=accounting_code);]]>
		</sql>
		<sql>
			<![CDATA[update ${db.schema.adapted}dwh_account_operation set accounting_code_id=(select id from ${db.schema.adapted}billing_accounting_code where code=accounting_code);]]>
		</sql>
		<sql>
			<![CDATA[update ${db.schema.adapted}dwh_journal_entries set accounting_code_id=(select id from ${db.schema.adapted}billing_accounting_code where code=accounting_code);]]>
		</sql>
		<sql>
			<![CDATA[update ${db.schema.adapted}ar_account_operation set accounting_code_id=(select id from ${db.schema.adapted}billing_accounting_code where code=account_code);]]>
		</sql>
		
		<sql>
			<![CDATA[update ${db.schema.adapted}billing_accounting_code_seq set next_val=(select id+1 from ${db.schema.adapted}billing_accounting_code order by id desc limit 1);]]>
			<![CDATA[update ${db.schema.adapted}billing_accounting_code set migrated=1;]]>
		</sql>
        <dropUniqueConstraint tableName="dwh_journal_entries" constraintName="uk_og8li9rlut4trrxgajab23j7y"/>
    </changeSet>
    
    <changeSet id="#1705_20180220-migration-end" author="EdwardPLegaspi" >        
		<dropColumn tableName="billing_invoice_sub_cat" columnName="accounting_code"></dropColumn>
		<dropColumn tableName="billing_tax" columnName="accounting_code"></dropColumn>
		<dropColumn tableName="billing_invoice_agregate" columnName="accounting_code"></dropColumn>
		<dropColumn tableName="dwh_account_operation" columnName="accounting_code"></dropColumn>
		<dropColumn tableName="dwh_journal_entries" columnName="accounting_code"></dropColumn>
		<dropColumn tableName="ar_occ_template" columnName="account_code"></dropColumn>
		<dropColumn tableName="ar_account_operation" columnName="account_code"></dropColumn>
		
		<addUniqueConstraint columnNames="origin_id, invoice_number, accounting_code_id" constraintName="uk_orinvacid" deferrable="false" disabled="false" initiallyDeferred="false" tableName="dwh_journal_entries" />
    </changeSet>
    
    <changeSet id="#3029_20180213 - Rating minimum on priceplan" author="EdwardPLegaspi">
    	<addColumn tableName="cat_price_plan_matrix">
    		<column name="minimum_amount_without_tax_el" type="varchar(2000)">
                <constraints nullable="true" />
            </column>
            <column name="minimum_amount_with_tax_el" type="varchar(2000)">
                <constraints nullable="true" />
            </column>
    	</addColumn>
    	
    	<addColumn tableName="billing_wallet_operation">
    		<column name="raw_amount_without_tax" type="numeric(23, 12)" />
            <column name="raw_amount_with_tax" type="numeric(23, 12)" />
    	</addColumn>
    </changeSet>
    
    <changeSet id="#3213_20180312 - add order history table" author="EdwardPLegaspi">
    	<createTable tableName="ord_order_history">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="ord_order_history_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="order_item_id" type="bigint" />
            <column name="service_instance_id" type="bigint" />
            <column name="action" type="varchar(25)">
            	<constraints nullable="false" />
            </column>
            <column name="event_date" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="order_number" type="varchar(100)" />            
		</createTable>
		<createSequence sequenceName="ord_order_history_seq" />
        <addForeignKeyConstraint baseColumnNames="order_item_id" baseTableName="ord_order_history" constraintName="fk_order_history_order_item" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
        	onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="ord_order_item" />
       	<addForeignKeyConstraint baseColumnNames="service_instance_id" baseTableName="ord_order_history" constraintName="fk_order_history_billing_service_instance" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
        	onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_service_instance" />
    </changeSet>
    
    <changeSet id="#3213_20180312 - add order history table - mysql" author="EdwardPLegaspi" dbms="mysql">
    	<createTable tableName="ord_order_history_seq">
			<column name="next_val" type="BIGINT">
				<constraints nullable="false" primaryKey="true" primaryKeyName="ord_order_history_seq_pk" />
			</column>
		</createTable>
		<sql>insert into ${db.schema.adapted}ord_order_history_seq values(1)</sql>
    </changeSet>
	 <changeSet author="anasseh" id="#3323_27032018">
	    <addUniqueConstraint 
	            columnNames="payment_method,country_id,trading_currency_id"
	            constraintName="uk_payment_gateway"
	            tableName="ar_payment_gateway"/>	           
	</changeSet>
	<changeSet id="perf_mediation_20180404" author="Wassim" dbms="postgresql">
		<sql>DROP INDEX IF EXISTS ${db.schema.adapted}rating_edr_index</sql>
        <sql>CREATE INDEX rating_edr_index ON ${db.schema.adapted}rating_edr(origin_batch, origin_record)</sql>
	</changeSet>
	
	<changeSet id="perf_mediation_20180409" author="PHUNGTienLan" dbms="mysql">
		<sql>DROP INDEX IF EXISTS rating_edr_index ON ${db.schema.adapted}rating_edr</sql>
        <sql>CREATE INDEX rating_edr_index ON ${db.schema.adapted}rating_edr(origin_batch, origin_record)</sql>
	</changeSet>   
	
	<changeSet id="#3351_20180407" author="EdwardPLegaspi">
		<modifyDataType tableName="dwh_report_extract" columnName="sql_query" newDataType="text" />
	</changeSet> 
	
	<changeSet id="#1706_20180408" author="EdwardPLegaspi">
		<createTable tableName="billing_finance_segment">
			<column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_billing_finance_segment" />
            </column>
            <column name="code" type="varchar(255)">
                <constraints nullable="false" />
            </column>
            <column name="description" type="varchar(255)" />
            <column name="version" type="int4" />
            <column name="disabled" type="${type.boolean}" defaultValueNumeric="0">
                <constraints nullable="false" />
            </column>
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="object_class" type="varchar(100)">
            	<constraints nullable="false"/>
            </column>
            <column name="field" type="varchar(100)">
            	<constraints nullable="false"/>
            </column>
		</createTable>
		
		<addUniqueConstraint columnNames="code" tableName="billing_finance_segment"/>
		<createSequence sequenceName="billing_finance_segment_seq" />
	</changeSet>
	
	<changeSet id="#1706_20180408-M" author="EdwardPLegaspi" dbms="mysql">
        <createTable tableName="billing_finance_segment_seq">
            <column name="next_val" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_billing_finance_segment_seq" />
            </column>
        </createTable>
        <sql>insert into ${db.schema.adapted}billing_finance_segment_seq values(1)</sql>
    </changeSet>
    
    <changeSet id="perf_computeOccAmount_20180412" author="Wassim" dbms="postgresql">
		<sql>DROP INDEX IF EXISTS ${db.schema.adapted}ar_account_operation_index</sql>
        <sql>CREATE INDEX ar_account_operation_index ON ${db.schema.adapted}ar_account_operation(customer_account_id)</sql>
	</changeSet>
	
	<changeSet id="perf_computeOccAmount_20180412" author="Wassim" dbms="mysql">
		<sql>DROP INDEX IF EXISTS ar_account_operation_index ON ${db.schema.adapted}ar_account_operation</sql>
        <sql>CREATE INDEX ar_account_operation_index ON ${db.schema.adapted}ar_account_operation(customer_account_id)</sql>
	</changeSet>   
	
	<changeSet id="#3019_20180312" author="AbdelmounaimAkadid">
    	<addColumn tableName="billing_billing_account">
            <column name="minimum_amount_el" type="varchar(2000)"  />           
            <column name="minimum_label_el" type="varchar(2000)"  />           
        </addColumn>
        <addColumn tableName="billing_service_instance">
            <column name="minimum_amount_el" type="varchar(2000)"  />           
            <column name="minimum_label_el" type="varchar(2000)"  />           
        </addColumn>
        <addColumn tableName="cat_service_template">
            <column name="minimum_amount_el" type="varchar(2000)"  />           
            <column name="minimum_label_el" type="varchar(2000)"  />           
        </addColumn>
        <addColumn tableName="billing_subscription">
            <column name="minimum_amount_el" type="varchar(2000)"  />           
            <column name="minimum_label_el" type="varchar(2000)"  />           
        </addColumn>
        <addColumn tableName="cat_offer_template">
            <column name="minimum_amount_el" type="varchar(2000)"  />           
            <column name="minimum_label_el" type="varchar(2000)"  />           
        </addColumn>
	</changeSet>
	
	<changeSet id="perf_cgi_20180426" author="Wassim" dbms="postgresql">
		<sql>DROP INDEX IF EXISTS ${db.schema.adapted}billing_invoice_quote_id</sql>
        <sql>CREATE INDEX billing_invoice_quote_id ON ${db.schema.adapted}billing_invoice(quote_id)</sql>
        
        <sql>DROP INDEX IF EXISTS ${db.schema.adapted}account_entity_upper_code</sql> <!-- duplicate because of using upper - need to update in core -->
        <sql>CREATE INDEX account_entity_upper_code ON ${db.schema.adapted}account_entity(UPPER(code))</sql>
        
        <sql>DROP INDEX IF EXISTS ${db.schema.adapted}rating_edr_status</sql>
        <sql>CREATE INDEX rating_edr_status ON ${db.schema.adapted}rating_edr(status)</sql>
        
        <sql>DROP INDEX IF EXISTS ${db.schema.adapted}billing_subscription_upper_code</sql> <!-- duplicate because of using upper - need to update in core -->
        <sql>CREATE INDEX billing_subscription_upper_code ON ${db.schema.adapted}billing_subscription(UPPER(code))</sql>
        
        <sql>DROP INDEX IF EXISTS ${db.schema.adapted}billing_wallet_operation_status</sql>
        <sql>CREATE INDEX billing_wallet_operation_status ON ${db.schema.adapted}billing_wallet_operation(status)</sql>
        
        <sql>DROP INDEX IF EXISTS ${db.schema.adapted}billing_invoice_agregate_category_inv_agg</sql>
        <sql>CREATE INDEX billing_invoice_agregate_category_inv_agg ON  ${db.schema.adapted}billing_invoice_agregate(category_invoice_agregate)</sql>
        
        <sql>DROP INDEX IF EXISTS ${db.schema.adapted}billing_invoice_billing_account_id</sql>
        <sql>CREATE INDEX billing_invoice_billing_account_id ON  ${db.schema.adapted}billing_invoice(billing_account_id)</sql>
        
        <sql>DROP INDEX IF EXISTS ${db.schema.adapted}medina_access_subscription_id</sql>
        <sql>CREATE INDEX medina_access_subscription_id ON  ${db.schema.adapted}medina_access(subscription_id)</sql>
	</changeSet>
	<changeSet id="perf_cgi_20180426" author="Wassim" dbms="mysql">
		<sql>DROP INDEX IF EXISTS ar_account_operation_index ON ${db.schema.adapted}ar_account_operation</sql>
        <sql>CREATE INDEX ar_account_operation_index ON ${db.schema.adapted}ar_account_operation(customer_account_id)</sql>
        
        <sql>DROP INDEX IF EXISTS billing_invoice_quote_id ON ${db.schema.adapted}billing_invoice</sql>
        <sql>CREATE INDEX billing_invoice_quote_id ON ${db.schema.adapted}billing_invoice(quote_id)</sql>
        
        <sql>DROP INDEX IF EXISTS rating_edr_status ON ${db.schema.adapted}rating_edr</sql>
        <sql>CREATE INDEX rating_edr_status ON ${db.schema.adapted}rating_edr(status)</sql>
        
        <sql>DROP INDEX IF EXISTS billing_subscription_upper_code ON ${db.schema.adapted}billing_subscription</sql> <!-- duplicate because of using upper - need to update in core -->
        <sql>CREATE INDEX billing_subscription_upper_code ON ${db.schema.adapted}billing_subscription(UPPER(code))</sql>
        
        <sql>DROP INDEX IF EXISTS billing_wallet_operation_status ON ${db.schema.adapted}billing_wallet_operation</sql>
        <sql>CREATE INDEX billing_wallet_operation_status ON ${db.schema.adapted}billing_wallet_operation(status)</sql>
        
        <sql>DROP INDEX IF EXISTS billing_invoice_agregate_category_inv_agg ON  ${db.schema.adapted}billing_invoice_agregate</sql>
        <sql>CREATE INDEX billing_invoice_agregate_category_inv_agg ON  ${db.schema.adapted}billing_invoice_agregate(category_invoice_agregate)</sql>
        
        <sql>DROP INDEX IF EXISTS billing_invoice_billing_account_id ON  ${db.schema.adapted}billing_invoice</sql>
        <sql>CREATE INDEX billing_invoice_billing_account_id ON  ${db.schema.adapted}billing_invoice(billing_account_id)</sql>
        
        <sql>DROP INDEX IF EXISTS medina_access_subscription_id ON ${db.schema.adapted}medina_access</sql>
        <sql>CREATE INDEX medina_access_subscription_id ON ${db.schema.adapted}medina_access(subscription_id)</sql>
	</changeSet>   
	
	<changeSet id="#3436_20180508" author="EdwardPLegaspi">
		<modifyDataType tableName="dwh_measurable_quant" columnName="sql_query" newDataType="text" />
	</changeSet>
	
    <changeSet id="#3446_20180512 secure payment history list api" author="anasseh">
       <addColumn tableName="ar_payment_history">
           <column name="customer_code" type="varchar(256)" />
       </addColumn>
    </changeSet>
    
    <changeSet id="#3254_accuentuated_search_postgresql" author="anasseh" dbms="postgresql">
       <sql splitStatements="false" stripComments="false"><![CDATA[    
       CREATE OR REPLACE FUNCTION ${db.schema.adapted}fn_unaccent(str TEXT) RETURNS TEXT AS $$
             BEGIN
                 RETURN  translate($1,
                                    'çÇâàÂÀéèêÉÈÊîÎûÛôÔ',
                                    'cCaaAAeeeEEEiIuUoO');
            END;
            $$ LANGUAGE plpgsql;
        ]]></sql>
    </changeSet>
    <changeSet id="#3254_accuentuated_search_mySql" author="anasseh" dbms="mysql">
        <sql>delete from   ${db.schema.adapted}crm_provider_pay_methods  where payment_method='NONE' ;</sql>
         <sql> drop function if exists ${db.schema.adapted}fn_unaccent;</sql>
            <sql splitStatements="false" stripComments="false"><![CDATA[         
                create function ${db.schema.adapted}fn_unaccent( input_text varchar(2000) )
                                returns varchar(2000)
                                begin                
                                    set @textvalue =  input_text;
                                    set @withaccents = 'çÇâàÂÀéèêÉÈÊîÎûÛôÔ';
                                    set @withoutaccents = 'cCaaAAeeeEEEiIuUoO';
                                    set @count = length(@withaccents);
                                    
                                    while @count > 0 do
                                        set @textvalue = replace(@textvalue, substring(@withaccents, @count, 1), substring(@withoutaccents, @count, 1));
                                        set @count = @count - 1;
                                    end while;                    
                                    return @textvalue;                
                end;
            ]]></sql>
    </changeSet>      

    <changeSet id="#3459_20180702" author="AndriusKarpavicius">
       <addColumn tableName="cat_wallet_template">
           <column name="reject_level" type="numeric(23, 12)" />
       </addColumn>
       <addColumn tableName="billing_wallet">
           <column name="reject_level" type="numeric(23, 12)" />
       </addColumn>
        <sql>update ${db.schema.adapted}cat_wallet_template set reject_level=0 where reject_level is null</sql>
        <sql>update ${db.schema.adapted}billing_wallet set reject_level=0 where reject_level is null</sql>
    </changeSet>
    
    <changeSet id="#4198_03052019" author="SaidRamli">
       <addColumn tableName="billing_invoice_type">
           <column name="invoice_accountable" type="${type.boolean}" defaultValueNumeric="1">
		        <constraints nullable="false" />
		    </column>
       </addColumn>
        <sql>update ${db.schema.adapted}billing_invoice_type set invoice_accountable = 1 where code not in ('QUOTE','DRAFT','PREPAID')</sql>
        <sql>update ${db.schema.adapted}billing_invoice_type set invoice_accountable = 0 where code in ('QUOTE','DRAFT','PREPAID')</sql>
    </changeSet>
    
    <changeSet id="#4229_2019050901" author="MohamedElYoussoufi" dbms="postgresql" >
         
        <sql>CREATE INDEX cust_cei_cet_and_code_index ON ${db.schema.adapted}cust_cei((lower(cet_code)),(lower(code)));</sql>
        
     </changeSet>
     
     <changeSet id="#4229_2019050902" author="MohamedElYoussoufi" dbms="mysql">
         
        <sql>CREATE INDEX cust_cei_cet_and_code_index ON ${db.schema.adapted}cust_cei(cet_code,code);</sql>
         
     </changeSet>
    
</databaseChangeLog> 