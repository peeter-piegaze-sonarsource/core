<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.5.xsd">

    <changeSet id="#4140_08042019" author="hznibar">
			<modifyDataType tableName="wf_history_action" columnName="result" newDataType="varchar(2000)" />
	</changeSet>
	
	<changeSet id="#4127_10042019" author="AbdelmounaimAkadid">
		<addColumn tableName="dwh_report_extract">
            <column name="output_dir" type="varchar(255)" />
        </addColumn>
        <sql>update ${db.schema.adapted}dwh_report_extract set output_dir = concat('reports/', category) where category is not null or category != ''
        </sql>
        <sql>update ${db.schema.adapted}dwh_report_extract set output_dir = 'reports' where category is null or category = ''
        </sql>
	</changeSet>

	<changeSet id="#4127_10042019" author="AbdelmounaimAkadid">
		<addColumn tableName="dwh_report_extract">
            <column name="output_dir" type="varchar(255)" />
        </addColumn>
        <sql>update ${db.schema.adapted}dwh_report_extract set output_dir = concat('reports/', category) where category is not null or category != ''
        </sql>
        <sql>update ${db.schema.adapted}dwh_report_extract set output_dir = 'reports' where category is null or category = ''
        </sql>
	</changeSet>

    <changeSet id="#4089_20190404" author="AbdellatifBARI">
        <sql>update ${db.schema.adapted}crm_custom_field_tmpl set applies_to = case

            when applies_to = 'PROVIDER'                then 'Provider'
            when applies_to = 'PRODUCT'                 then 'ProductTemplate'
            when applies_to = 'PRODUCT_INSTANCE'        then 'ProductInstance'
            when applies_to = 'OFFER'                   then 'OfferTemplate'
            when applies_to = 'SELLER'                  then 'Seller'
            when applies_to = 'CUST'                    then 'Customer'
            when applies_to = 'CA'                      then 'CustomerAccount'
            when applies_to = 'BA'                      then 'BillingAccount'
            when applies_to = 'UA'                      then 'UserAccount'
            when applies_to = 'SERVICE'                 then 'ServiceTemplate'
            when applies_to = 'SERVICE_INSTANCE'        then 'ServiceInstance'
            when applies_to = 'SUB'                     then 'Subscription'
            when applies_to = 'ACC'                     then 'Access'
            when applies_to = 'CHARGE'                  then 'ChargeTemplate'
            when applies_to = 'PRICEPLAN'               then 'PricePlanMatrix'

            when applies_to = 'BILLING_CYCLE'           then 'BillingCycle'
            when applies_to = 'TAX'                     then 'Tax'
            when applies_to = 'INV_CAT'                 then 'InvoiceCategory'
            when applies_to = 'INVOICE'                 then 'Invoice'
            when applies_to = 'ACCT_CODE'               then 'AccountingCode'
            when applies_to = 'FILTER'                  then 'Filter'
            when applies_to = 'QUOTE'                   then 'Quote'
            when applies_to = 'ORDER'                   then 'Order'
            when applies_to = 'USER'                    then 'User'
            when applies_to = 'JOB'                     then 'JobInstance'
            when applies_to = 'DISCOUNT_PLAN_INSTANCE'  then 'DiscountPlanInstance'
            when applies_to = 'DISCOUNT_PLAN'           then 'DiscountPlan'
            when applies_to = 'OFFER_CATEGORY'          then 'OfferTemplateCategory'
            when applies_to = 'INV_SUB_CAT'             then 'InvoiceSubCategory'
            when applies_to = 'ACC_OP'                  then 'AccountOperation'

            when applies_to = 'BILLING_RUN'             then 'BillingRun'
            when applies_to = 'INVOICE_TYPE'            then 'InvoiceType'
            when applies_to = 'DISCOUNT_PLAN_ITEM'      then 'DiscountPlanItem'
            when applies_to = 'OTH_TR'                  then 'OtherTransaction'
            when applies_to = 'REPORT'                  then 'ReportExtract'
            when applies_to = 'BUNDLE'                  then 'BundleTemplate'
            when applies_to = 'PAYMENT_SCH_INSTANCE'    then 'PaymentScheduleInstance'
            when applies_to = 'DDREQ_BUILDER'           then 'DDRequestBuilder'
            when applies_to = 'PAYMENT_SCH'             then 'PaymentScheduleTemplate'

            when applies_to like 'JOB_%'                then  concat('JobInstance_', substring(applies_to, length('JOB_')+1, length(applies_to)))

            else applies_to

            end where applies_to is not null
        </sql>
    </changeSet>

	<changeSet id="#4107_20190515" author="EdwardPLegaspi">
		<createTable tableName="adm_role_secured_entity">
			<column name="role_id" type="bigint">
				<constraints nullable="false" />
			</column>
			<column name="code" type="varchar(255)">
				<constraints nullable="false" />
			</column>
			<column name="entity_class" type="varchar(255)">
				<constraints nullable="false" />
			</column>
		</createTable>
		<addPrimaryKey columnNames="role_id, code, entity_class"
			constraintName="adm_role_secured_entity_pkey"
			tableName="adm_role_secured_entity" />
	</changeSet>
    
    <changeSet id="#4117_20190405" author="AmineBENAICHA">
    	<addColumn tableName="wf_instance">
            <column name="entity_instance_id" type="bigint" >
            	<constraints nullable="false" />
            </column>
        </addColumn>
        <createIndex tableName="wf_instance" indexName="wf_instance_entity_id_idx">
            <column name="entity_instance_id" type="bigint"/>
        </createIndex>
    </changeSet>

    <changeSet id="#4179_20190417" author="AndriusKarpavicius">
        <addColumn tableName="meveo_script_instance">
            <column name="reuse" type="${type.boolean}" defaultValueNumeric="0"/>
        </addColumn>
    </changeSet>
    
    <changeSet id="#4148_20190418 - Add runAsync on notification" author="EdwardPLegaspi">
    	<addColumn tableName="adm_notification">
            <column name="run_async" type="${type.boolean}" defaultValueNumeric="0"/>
        </addColumn>
    </changeSet>
    
    <changeSet id="#3683_20190415" author="YoussefIZEM">
         <addColumn tableName="adm_notif_email">
            <column name="email_template_id" type="bigint"></column>
        </addColumn>
         <addColumn tableName="adm_notification">
            <column name="cf_values_accum" type="${type.json}"></column>
            <column name="cf_values" type="${type.json}"></column>
            <column name="uuid" type="varchar(60)" />
        </addColumn>
        <sql>update ${db.schema.adapted}adm_notification set uuid = id</sql>
        <sql>update ${db.schema.adapted}adm_notif_email set email_template_id=NEXTVAL('${db.schema.adapted}com_msg_tmpl_seq')</sql>
        <sql>
            INSERT INTO ${db.schema.adapted}com_message_template(id, version, created, code, subject, textcontent, htmlcontent, media)   
            SELECT email_template_id, 0, now(), notif.code, email_subject, email_body, email_html_body, 'EMAIL' as media
            FROM ${db.schema.adapted}adm_notif_email email
            LEFT JOIN ${db.schema.adapted}adm_notification notif  on notif.id = email.id
        </sql>
        <addForeignKeyConstraint baseColumnNames="email_template_id" baseTableName="adm_notif_email" constraintName="fk_com_message_template" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="com_message_template" />
                    
        <dropColumn tableName="adm_notif_email">
            <column name="email_body"></column>
            <column name="email_html_body"></column>
            <column name="email_subject"></column>
        </dropColumn>
     </changeSet>
     
     <changeSet id="#4208_2019042601" author="MohamedElYoussoufi" dbms="postgresql" >
     	
        <sql>CREATE INDEX cust_cei_cet_and_code_index ON ${db.schema.adapted}cust_cei((lower(cet_code)),(lower(code)));</sql>
        
     </changeSet>
     
     <changeSet id="#4208_2019042602" author="MohamedElYoussoufi" dbms="mysql">
     	
        <sql>CREATE INDEX cust_cei_cet_and_code_index ON ${db.schema.adapted}cust_cei(cet_code,code);</sql>
     	
     </changeSet>
     
     
     <changeSet id="#3692_20190426" author="AndriusKarpavicius">
        <modifyDataType tableName="ar_payment_gateway" columnName="iban" newDataType="varchar(80)" />
    </changeSet>
    
    <changeSet id="#4207_2019042901" author="MohamedElYoussoufi">
     	
     	<addColumn tableName="billing_rated_transaction">
            <column name="offer_id" type="bigint"></column>
        </addColumn>
        
        <addForeignKeyConstraint baseColumnNames="offer_id" baseTableName="billing_rated_transaction" constraintName="fk_billing_rated_transaction_offer_template" deferrable="false"
            initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_offer_template" />
            
        <addColumn tableName="billing_wallet_operation">
            <column name="offer_id" type="bigint"></column>
        </addColumn>
        
        <addForeignKeyConstraint baseColumnNames="offer_id" baseTableName="billing_wallet_operation" constraintName="fk_billing_wallet_operation_offer_template" deferrable="false"
            initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_offer_template" />
            
        <sql>
        	update ${db.schema.adapted}billing_wallet_operation set offer_code = null where offer_code = 'NO_OFFER';
        </sql>
          
      </changeSet>
      
      <changeSet id="#4207_2019042902" author="MohamedElYoussoufi" dbms="postgresql">
      
        <sql>
        	 	update ${db.schema.adapted}billing_rated_transaction rt set offer_id = (select s.offer_id from ${db.schema.adapted}billing_subscription s where s.id=rt.subscription_id and rt.subscription_id is not null)
        </sql>
        
        <sql>
        		update ${db.schema.adapted}billing_wallet_operation wo set offer_id = (select s.offer_id from ${db.schema.adapted}billing_subscription s where s.id=wo.subscription_id and wo.subscription_id is not null)
        </sql>
      
      </changeSet>
      
      <changeSet id="#4207_2019042903" author="MohamedElYoussoufi" dbms="mysql">
      
      	<sql>
        	 update ${db.schema.adapted}billing_rated_transaction rt join ${db.schema.adapted}billing_subscription s on s.id=rt.subscription_id  set offer_id = s.offer_id where rt.subscription_id is not null
        </sql>
        
        <sql>
        	update ${db.schema.adapted}billing_wallet_operation wo join ${db.schema.adapted}billing_subscription s on s.id=wo.subscription_id  set offer_id = s.offer_id where wo.subscription_id is not null
		</sql>
      
      </changeSet>
      
      <changeSet id="#4207_2019042904" author="MohamedElYoussoufi">
      	<dropColumn tableName="billing_rated_transaction">
            <column name="offer_code"></column>
        </dropColumn>
      </changeSet>

	<changeSet id="#4156_20190423" author="EdwardPLegaspi">
		<addColumn tableName="meveo_job_instance">
			<column name="verbose_report" type="${type.boolean}"
				defaultValueNumeric="1" />
		</addColumn>

		<update tableName="meveo_job_instance">
			<column name="verbose_report" valueNumeric="1"></column>
		</update>
	</changeSet>
    
    <changeSet id="#4198_03052019" author="SaidRamli">
       <addColumn tableName="billing_invoice_type">
           <column name="invoice_accountable" type="${type.boolean}" defaultValueNumeric="1">
		        <constraints nullable="false" />
		    </column>
       </addColumn>
        <sql>update ${db.schema.adapted}billing_invoice_type set invoice_accountable = 1 where code not in ('QUOTE','DRAFT','PREPAID')</sql>
        <sql>update ${db.schema.adapted}billing_invoice_type set invoice_accountable = 0 where code in ('QUOTE','DRAFT','PREPAID')</sql>
    </changeSet>

    <changeSet id="#4156_08052019" author="AndriusKarpavicius">
        <addDefaultValue tableName="meveo_job_instance" columnName="exclude_inv_without_amount" defaultValueNumeric="0" />
        <sql>update ${db.schema.adapted}meveo_job_instance set exclude_inv_without_amount = 0 where exclude_inv_without_amount is null</sql>
    </changeSet>

    <changeSet author="FranckValot" id="#3148_20190508 - knowledge center">        
        <createTable tableName="kc_post">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="kc_post_pkey" />
            </column>
            <column name="code" type="varchar(255)">
                <constraints nullable="false" />
            </column>
            <column name="description" type="varchar(255)"/>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="content" type="varchar(2000)">
                <constraints nullable="false" />
            </column>
            <column name="collection_id" type="bigint"/>
        </createTable>
               
        <createTable tableName="kc_collection">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="kc_collection_pkey" />
            </column>
            <column name="code" type="varchar(255)">
                <constraints nullable="false" />
            </column>
            <column name="description" type="varchar(255)"/>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="name" type="varchar(255)" />
            <column name="collection_id" type="bigint"/>
        </createTable>

        <createSequence sequenceName="kc_collection_seq" />

        <createTable tableName="kc_comments">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="kc_comments_pkey" />
            </column>
            <column name="code" type="varchar(255)">
                <constraints nullable="false" />
            </column>
            <column name="description" type="varchar(255)"/>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="content" type="varchar(2000)">
                <constraints nullable="false" />
            </column>
            <column name="post_id" type="bigint"/>
        </createTable>
        
        <createSequence sequenceName="kc_comments_seq" />
    
        <createTable tableName="kc_post_tag">
            <column name="post_id" type="bigint" />
            <column name="tag" type="varchar(100)"/>
        </createTable>

        <addPrimaryKey columnNames="post_id, tag" constraintName="kc_post_tag_pkey" tableName="kc_post_tag" />
    </changeSet>
</databaseChangeLog> 
